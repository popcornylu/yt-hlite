{% extends "base.html" %}

{% block title %}YouTube Highlights - Export{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Export Highlights</h1>
    <p>Download and compile your highlight video</p>
</div>

<!-- Cache Status (YouTube only) -->
{% if source_type == 'youtube' %}
<div class="card" id="cache-status-card">
    <div class="card-header">
        <h2>Video Status</h2>
    </div>
    <div class="cache-status">
        <div class="cache-item">
            <span class="cache-label">Audio (for analysis)</span>
            <span class="cache-value" id="audio-status">
                {% if cache_info and cache_info.audio_cached %}
                    <span class="status-cached">‚úì Cached ({{ cache_info.audio_size }})</span>
                {% else %}
                    <span class="status-not-cached">Not downloaded</span>
                {% endif %}
            </span>
        </div>
        <div class="cache-item">
            <span class="cache-label">Video (for export)</span>
            <span class="cache-value" id="video-status">
                {% if cache_info and cache_info.video_cached %}
                    <span class="status-cached">‚úì Cached ({{ cache_info.video_size }})</span>
                {% else %}
                    <span class="status-not-cached">Not downloaded - will download when exporting</span>
                {% endif %}
            </span>
        </div>
        {% if cache_info %}
        <div class="cache-path">
            <small>Cache: {{ cache_info.cache_dir }}</small>
        </div>
        {% endif %}
    </div>
</div>
{% endif %}

<!-- Export Options -->
<div class="card">
    <div class="card-header">
        <h2>Export Options</h2>
    </div>
    <div class="export-grid three-col">
        <div class="export-option">
            <div class="export-icon">üìã</div>
            <h3>Export Timecodes</h3>
            <p>Copy timestamp list to clipboard (instant)</p>
            <button class="btn btn-secondary btn-large" onclick="exportTimecodes()">
                Copy Timecodes
            </button>
        </div>
        <div class="export-option">
            <div class="export-icon">üìù</div>
            <h3>Copy for Description</h3>
            <p>YouTube-ready timestamps for video description</p>
            <button class="btn btn-secondary btn-large" onclick="exportForDescription()">
                Copy for Description
            </button>
        </div>
        <div class="export-option primary">
            <div class="export-icon">üé¨</div>
            <h3>Compile Video</h3>
            <p>Generate a single highlight video file</p>
            <button class="btn btn-primary btn-large" id="compile-btn" onclick="startCompile()">
                Start Export
            </button>
        </div>
    </div>
</div>

<!-- Progress Section (hidden initially) -->
<div id="progress-section" class="card hidden">
    <div class="card-header">
        <h2>Export Progress</h2>
    </div>
    <div class="progress-content">
        <!-- Step 1: Download (YouTube only) -->
        {% if source_type == 'youtube' %}
        <div class="progress-step" id="step-download">
            <div class="step-header">
                <span class="step-number">1</span>
                <span class="step-title">Downloading Video</span>
                <span class="step-status" id="download-status">Waiting...</span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="download-progress"></div>
            </div>
            <div class="step-detail" id="download-detail">--</div>
        </div>
        {% endif %}

        <!-- Step 2: Processing -->
        <div class="progress-step" id="step-process">
            <div class="step-header">
                <span class="step-number">{% if source_type == 'youtube' %}2{% else %}1{% endif %}</span>
                <span class="step-title">Processing Clips</span>
                <span class="step-status" id="process-status">Waiting...</span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="process-progress"></div>
            </div>
            <div class="step-detail" id="process-detail">--</div>
        </div>

        <!-- Overall Status -->
        <div class="overall-status">
            <span id="overall-text">Preparing...</span>
        </div>
    </div>
</div>

<!-- Timecodes Section (hidden initially) -->
<div id="timecodes-section" class="card hidden">
    <div class="card-header">
        <h2>Timecodes</h2>
        <button class="btn btn-secondary" onclick="copyTimecodes()">Copy Again</button>
    </div>
    <pre id="timecodes-output" class="timecodes-output"></pre>
</div>

<!-- Result Section (hidden initially) -->
<div id="result-section" class="card hidden">
    <div class="card-header">
        <h2>Export Complete!</h2>
    </div>
    <div class="result-content">
        <video id="result-video" controls>
            <source src="" type="video/mp4">
        </video>
        <div class="result-actions">
            <a id="download-link" class="btn btn-primary btn-large" download>
                Download Video
            </a>
            <button class="btn btn-secondary" onclick="window.location.href='{{ url_for('index') }}'">
                Start New Video
            </button>
        </div>
    </div>
</div>

<style>
/* Cache Status */
.cache-status {
    padding: 1rem;
}

.cache-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem 0;
    border-bottom: 1px solid #e9ecef;
}

.cache-item:last-of-type {
    border-bottom: none;
}

.cache-label {
    font-weight: 500;
}

.status-cached {
    color: #28a745;
    font-weight: 600;
}

.status-not-cached {
    color: #6c757d;
}

.cache-path {
    padding-top: 0.5rem;
    color: #6c757d;
}

/* Export Grid */
.export-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 2rem;
    padding: 1.5rem;
}

.export-grid.three-col {
    grid-template-columns: 1fr 1fr 1fr;
}

.export-option {
    text-align: center;
    padding: 2rem;
    background: #f8f9fa;
    border-radius: 12px;
    border: 2px solid transparent;
    transition: all 0.2s;
}

.export-option.primary {
    background: #e3f2fd;
    border-color: #2196f3;
}

.export-option:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.export-icon {
    font-size: 3rem;
    margin-bottom: 1rem;
}

.export-option h3 {
    margin: 0 0 0.5rem 0;
}

.export-option p {
    color: #6c757d;
    margin: 0 0 1.5rem 0;
}

/* Progress Section */
.progress-content {
    padding: 1.5rem;
}

.progress-step {
    margin-bottom: 2rem;
    opacity: 0.5;
    transition: opacity 0.3s;
}

.progress-step.active {
    opacity: 1;
}

.progress-step.complete {
    opacity: 1;
}

.progress-step.complete .step-number {
    background: #28a745;
}

.step-header {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 0.75rem;
}

.step-number {
    width: 28px;
    height: 28px;
    background: #6c757d;
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    font-size: 0.875rem;
}

.progress-step.active .step-number {
    background: #007bff;
}

.step-title {
    font-weight: 600;
    flex: 1;
}

.step-status {
    font-size: 0.875rem;
    color: #6c757d;
}

.progress-step.active .step-status {
    color: #007bff;
}

.progress-step.complete .step-status {
    color: #28a745;
}

.progress-bar {
    height: 8px;
    background: #e9ecef;
    border-radius: 4px;
    overflow: hidden;
    margin-bottom: 0.5rem;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #007bff, #28a745);
    border-radius: 4px;
    width: 0;
    transition: width 0.3s;
}

.progress-step.complete .progress-fill {
    width: 100%;
    background: #28a745;
}

.step-detail {
    font-size: 0.875rem;
    color: #6c757d;
}

.overall-status {
    text-align: center;
    padding: 1rem;
    background: #f8f9fa;
    border-radius: 8px;
    font-weight: 500;
}

/* Timecodes */
.timecodes-output {
    background: #f8f9fa;
    padding: 1rem;
    border-radius: 4px;
    font-family: monospace;
    font-size: 0.875rem;
    white-space: pre-wrap;
    max-height: 300px;
    overflow-y: auto;
}

/* Result Section */
.result-content {
    padding: 1.5rem;
}

.result-content video {
    width: 100%;
    max-height: 500px;
    background: #000;
    border-radius: 8px;
    margin-bottom: 1.5rem;
}

.result-actions {
    display: flex;
    gap: 1rem;
    justify-content: center;
}

.btn-large {
    padding: 1rem 2rem;
    font-size: 1.125rem;
}

/* Responsive */
@media (max-width: 900px) {
    .export-grid,
    .export-grid.three-col {
        grid-template-columns: 1fr;
    }
}
</style>
{% endblock %}

{% block scripts %}
<script>
const isYouTube = {{ 'true' if source_type == 'youtube' else 'false' }};
let selectedHighlightIds = [];

document.addEventListener('DOMContentLoaded', async () => {
    // Load highlights from API
    try {
        const response = await fetch('/api/highlights');
        const data = await response.json();
        selectedHighlightIds = (data.highlights || []).map(h => h.id);
    } catch (e) {
        // Fallback to sessionStorage
        const saved = sessionStorage.getItem('selectedHighlights');
        if (saved) {
            selectedHighlightIds = JSON.parse(saved);
        }
    }

    if (selectedHighlightIds.length === 0) {
        document.getElementById('compile-btn').disabled = true;
        document.getElementById('compile-btn').textContent = 'No highlights created';
    }
});

async function exportTimecodes() {
    if (selectedHighlightIds.length === 0) {
        alert('No highlights created.');
        return;
    }

    const url = `/api/export-highlight-timecodes?highlight_ids=${selectedHighlightIds.join('&highlight_ids=')}`;

    try {
        const response = await fetch(url);
        const data = await response.json();

        if (data.timecodes) {
            document.getElementById('timecodes-section').classList.remove('hidden');
            document.getElementById('timecodes-output').textContent = data.timecodes;

            await navigator.clipboard.writeText(data.timecodes);
            alert(`${data.count} timecodes copied to clipboard!`);
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

function copyTimecodes() {
    const text = document.getElementById('timecodes-output').textContent;
    navigator.clipboard.writeText(text).then(() => {
        alert('Copied to clipboard!');
    });
}

async function exportForDescription() {
    if (selectedHighlightIds.length === 0) {
        alert('No highlights created.');
        return;
    }

    const url = `/api/export-highlight-description?highlight_ids=${selectedHighlightIds.join('&highlight_ids=')}`;

    try {
        const response = await fetch(url);
        const data = await response.json();

        if (data.text) {
            document.getElementById('timecodes-section').classList.remove('hidden');
            document.getElementById('timecodes-output').textContent = data.text;

            await navigator.clipboard.writeText(data.text);
            alert(`${data.count} highlights copied for YouTube description!`);
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

async function startCompile() {
    if (selectedHighlightIds.length === 0) {
        alert('No highlights created.');
        return;
    }

    const compileBtn = document.getElementById('compile-btn');
    const progressSection = document.getElementById('progress-section');

    compileBtn.disabled = true;
    compileBtn.textContent = 'Exporting...';
    progressSection.classList.remove('hidden');

    if (isYouTube) {
        // Phase 1: Download video
        await downloadVideo();
    }

    // Phase 2: Compile
    await compileVideo();
}

async function downloadVideo() {
    const stepEl = document.getElementById('step-download');
    const statusEl = document.getElementById('download-status');
    const progressEl = document.getElementById('download-progress');
    const detailEl = document.getElementById('download-detail');
    const overallEl = document.getElementById('overall-text');

    stepEl.classList.add('active');
    statusEl.textContent = 'Downloading...';
    overallEl.textContent = 'Downloading YouTube video...';

    // Check if already cached
    try {
        const cacheResponse = await fetch('/api/cache-status');
        const cacheData = await cacheResponse.json();

        if (cacheData.video_cached) {
            progressEl.style.width = '100%';
            statusEl.textContent = 'Cached';
            detailEl.textContent = `Using cached video (${cacheData.video_size})`;
            stepEl.classList.remove('active');
            stepEl.classList.add('complete');
            return;
        }
    } catch (e) {
        // Continue with download
    }

    // Simulate download progress (actual download happens during compile)
    detailEl.textContent = 'Starting download...';

    // The actual download happens in the compile endpoint
    // For now, we'll show indeterminate progress
    let progress = 0;
    const interval = setInterval(() => {
        progress = Math.min(progress + 2, 90);
        progressEl.style.width = `${progress}%`;
        detailEl.textContent = `Downloading... ${progress}%`;
    }, 500);

    // Wait for download to complete (happens during compile)
    // We'll mark it complete when compile starts
    await new Promise(resolve => setTimeout(resolve, 1000));

    clearInterval(interval);
    progressEl.style.width = '100%';
    statusEl.textContent = 'Complete';
    detailEl.textContent = 'Video downloaded';
    stepEl.classList.remove('active');
    stepEl.classList.add('complete');
}

async function compileVideo() {
    const stepEl = document.getElementById('step-process');
    const statusEl = document.getElementById('process-status');
    const progressEl = document.getElementById('process-progress');
    const detailEl = document.getElementById('process-detail');
    const overallEl = document.getElementById('overall-text');

    stepEl.classList.add('active');
    statusEl.textContent = 'Processing...';
    overallEl.textContent = 'Compiling highlight video...';
    detailEl.textContent = 'Extracting clips...';

    // Simulate progress
    let progress = 0;
    const stages = [
        { pct: 20, text: 'Extracting clips...' },
        { pct: 50, text: 'Processing video...' },
        { pct: 80, text: 'Adding transitions...' },
        { pct: 95, text: 'Finalizing...' },
    ];
    let stageIndex = 0;

    const interval = setInterval(() => {
        progress = Math.min(progress + 3, stages[stageIndex]?.pct || 95);
        progressEl.style.width = `${progress}%`;

        if (stageIndex < stages.length && progress >= stages[stageIndex].pct) {
            detailEl.textContent = stages[stageIndex].text;
            stageIndex++;
        }
    }, 300);

    try {
        const response = await fetch('/api/compile-highlights', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ highlight_ids: selectedHighlightIds })
        });

        clearInterval(interval);

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error || 'Compilation failed');
        }

        const data = await response.json();

        progressEl.style.width = '100%';
        statusEl.textContent = 'Complete';
        detailEl.textContent = 'Video compiled successfully';
        stepEl.classList.remove('active');
        stepEl.classList.add('complete');
        overallEl.textContent = 'Export complete!';

        // Show result
        showResult(data);

    } catch (error) {
        clearInterval(interval);
        statusEl.textContent = 'Failed';
        detailEl.textContent = error.message;
        overallEl.textContent = 'Export failed: ' + error.message;
        progressEl.style.background = '#dc3545';

        document.getElementById('compile-btn').disabled = false;
        document.getElementById('compile-btn').textContent = 'Retry Export';
    }
}

function showResult(data) {
    const resultSection = document.getElementById('result-section');
    const resultVideo = document.getElementById('result-video');
    const downloadLink = document.getElementById('download-link');

    resultVideo.src = data.output_path;
    downloadLink.href = data.output_path;
    downloadLink.download = data.filename || 'highlights.mp4';

    resultSection.classList.remove('hidden');
    resultSection.scrollIntoView({ behavior: 'smooth' });

    // Update cache status
    updateCacheStatus();
}

async function updateCacheStatus() {
    if (!isYouTube) return;

    try {
        const response = await fetch('/api/cache-status');
        const data = await response.json();

        if (data.video_cached) {
            document.getElementById('video-status').innerHTML =
                `<span class="status-cached">‚úì Cached (${data.video_size})</span>`;
        }
    } catch (e) {
        // Ignore
    }
}
</script>
{% endblock %}
