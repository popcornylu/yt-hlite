{% extends "base.html" %}

{% block title %}TT Highlights - Final Review{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Final Review</h1>
    <p>Preview and compile your highlight reel</p>
</div>

<!-- Timeline Preview Section -->
<div class="card">
    <div class="card-header">
        <h2>Highlight Timeline</h2>
        <div class="timeline-legend">
            <span class="legend-item"><span class="legend-color selected"></span> Selected</span>
            <span class="legend-item"><span class="legend-color unselected"></span> Not Selected</span>
        </div>
    </div>
    <div class="timeline-preview-container">
        <div class="timeline-bar" id="review-timeline">
            <!-- Segments populated by JS -->
        </div>
        <div id="preview-playhead" class="preview-playhead"></div>
    </div>
    <div class="time-labels" id="time-labels"></div>
</div>

<!-- Video Preview Section -->
<div class="card">
    <div class="card-header">
        <h2>Preview Simulation</h2>
        <div class="preview-controls">
            <button class="btn btn-primary" id="simulate-btn" onclick="startSimulation()">
                ▶ Play Preview
            </button>
            <button class="btn btn-secondary" id="stop-btn" onclick="stopSimulation()" disabled>
                ■ Stop
            </button>
        </div>
    </div>
    <div class="preview-section">
        <video id="preview-video" controls>
            <source src="/video" type="video/mp4">
        </video>
        <div class="preview-info">
            <div class="preview-status" id="preview-status">
                <span class="status-label">Status:</span>
                <span class="status-value" id="status-text">Ready</span>
            </div>
            <div class="preview-progress">
                <span class="progress-label">Clip:</span>
                <span class="progress-value" id="clip-progress">- / -</span>
            </div>
            <div class="preview-current">
                <span class="current-label">Current:</span>
                <span class="current-value" id="current-clip-info">--</span>
            </div>
            <div class="preview-total">
                <span class="total-label">Total Duration:</span>
                <span class="total-value" id="preview-total-duration">0:00</span>
            </div>
        </div>
    </div>
</div>

<!-- Compilation Settings -->
<div class="card">
    <div class="card-header">
        <h2>Compilation Settings</h2>
    </div>
    <div class="settings-grid">
        <div class="setting-item">
            <label for="target-duration">Target Duration</label>
            <select id="target-duration">
                <option value="120">2 minutes</option>
                <option value="180" selected>3 minutes</option>
                <option value="300">5 minutes</option>
                <option value="600">10 minutes</option>
            </select>
        </div>
        <div class="setting-item">
            <label for="max-clips">Max Clips</label>
            <select id="max-clips">
                <option value="5">5 clips</option>
                <option value="10">10 clips</option>
                <option value="15" selected>15 clips</option>
                <option value="20">20 clips</option>
            </select>
        </div>
        <div class="setting-item">
            <label for="min-score">Min Score</label>
            <input type="number" id="min-score-setting" value="30" min="0" max="100">
        </div>
        <div class="setting-item">
            <label for="add-transitions">
                <input type="checkbox" id="add-transitions" checked>
                Add fade transitions
            </label>
        </div>
    </div>
    <div class="card-footer">
        <button class="btn btn-secondary" onclick="autoSelect()">
            Auto-select Best Highlights
        </button>
    </div>
</div>

<!-- Sidebar Toggle Button -->
<button class="sidebar-toggle" onclick="toggleSidebar()" title="Toggle Selected Highlights">
    <span class="toggle-icon">☰</span>
</button>

<!-- Selected Highlights Sidebar (Drawer) -->
<div class="sidebar hidden" id="sidebar">
    <div class="sidebar-header">
        <h3>Selected Highlights</h3>
        <div class="sidebar-header-actions">
            <span class="badge" id="selection-badge">0 selected</span>
            <button class="btn btn-small btn-icon" onclick="toggleSidebar()" title="Close">✕</button>
        </div>
    </div>

    <div id="selected-list" class="selected-list">
        <div class="empty-state">
            <p>No highlights selected yet.</p>
            <p>Go to <a href="{{ url_for('candidates') }}">Candidates</a> to select highlights,
               or click "Auto-select" above.</p>
        </div>
    </div>

    <div id="compilation-info" class="compilation-info hidden">
        <div class="info-row">
            <span>Total Duration:</span>
            <strong id="total-duration">0:00</strong>
        </div>
        <div class="info-row">
            <span>Number of Clips:</span>
            <strong id="clip-count">0</strong>
        </div>
    </div>
</div>

<!-- Feedback Summary -->
<div class="card">
    <div class="card-header">
        <h2>Feedback Summary</h2>
    </div>
    <div id="feedback-summary" class="feedback-summary">
        <!-- Populated by JavaScript -->
    </div>
</div>

<!-- Compile Section -->
<div class="compile-section">
    <div class="compile-warning" id="compile-warning">
        <strong>Note:</strong> Compilation may take a few minutes depending on video length.
    </div>
    <button class="btn btn-primary btn-large" id="compile-btn" onclick="compileHighlights()">
        Generate Highlight Video
    </button>
</div>

<div id="progress-section" class="card hidden">
    <div class="card-header">
        <h2>Compilation Progress</h2>
    </div>
    <div class="progress-content">
        <div class="progress-bar large">
            <div class="progress-fill" id="compile-progress"></div>
        </div>
        <p id="compile-status">Preparing clips...</p>
    </div>
</div>

<div id="result-section" class="card hidden">
    <div class="card-header">
        <h2>Highlight Video Ready!</h2>
    </div>
    <div class="result-content">
        <video id="result-video" controls style="width: 100%; max-height: 500px;">
            <source src="" type="video/mp4">
        </video>
        <div class="result-actions">
            <a id="download-link" class="btn btn-primary btn-large" download>
                Download Video
            </a>
            <button class="btn btn-secondary" onclick="startOver()">
                Start Over with New Video
            </button>
        </div>
    </div>
</div>

<style>
/* Sidebar Toggle Button */
.sidebar-toggle {
    position: fixed;
    top: 80px;
    right: 0;
    z-index: 200;
    background: #007bff;
    color: white;
    border: none;
    border-radius: 8px 0 0 8px;
    padding: 0.75rem 0.5rem;
    cursor: pointer;
    box-shadow: -2px 2px 8px rgba(0,0,0,0.15);
    transition: transform 0.3s ease;
}

.sidebar-toggle:hover {
    background: #0056b3;
}

.sidebar-toggle .toggle-icon {
    font-size: 1.25rem;
}

.sidebar-toggle.sidebar-open {
    transform: translateX(-300px);
}

/* Sidebar */
.sidebar {
    position: fixed;
    top: 60px;
    right: 0;
    width: 300px;
    height: calc(100vh - 60px);
    background: white;
    box-shadow: -4px 0 12px rgba(0,0,0,0.15);
    display: flex;
    flex-direction: column;
    overflow: hidden;
    z-index: 150;
    transform: translateX(0);
    transition: transform 0.3s ease;
}

.sidebar.hidden {
    transform: translateX(100%);
}

.sidebar-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem;
    border-bottom: 1px solid #e9ecef;
}

.sidebar-header h3 {
    margin: 0;
    font-size: 1rem;
}

.sidebar-header-actions {
    display: flex;
    gap: 0.5rem;
    align-items: center;
}

.btn-small {
    padding: 0.25rem 0.5rem;
    font-size: 0.75rem;
}

/* Timeline Preview */
.timeline-preview-container {
    position: relative;
    padding: 1rem 0;
}

.timeline-bar {
    height: 40px;
    background: #e9ecef;
    border-radius: 4px;
    position: relative;
    overflow: hidden;
}

.timeline-segment {
    position: absolute;
    height: 100%;
    transition: opacity 0.2s;
}

.timeline-segment.selected {
    background: #28a745;
    opacity: 0.8;
}

.timeline-segment.unselected {
    background: #6c757d;
    opacity: 0.3;
}

.timeline-segment:hover {
    opacity: 1;
}

.preview-playhead {
    position: absolute;
    top: 1rem;
    height: 40px;
    width: 3px;
    background: #ff0000;
    z-index: 10;
    left: 0;
    display: none;
}

.preview-playhead::before {
    content: '';
    position: absolute;
    top: -6px;
    left: 50%;
    transform: translateX(-50%);
    width: 12px;
    height: 12px;
    background: #ff0000;
    border-radius: 50%;
}

.time-labels {
    display: flex;
    justify-content: space-between;
    font-size: 0.75rem;
    color: #6c757d;
    margin-top: 0.25rem;
}

.timeline-legend {
    display: flex;
    gap: 1rem;
    font-size: 0.875rem;
}

.legend-item {
    display: flex;
    align-items: center;
    gap: 0.25rem;
}

.legend-color {
    width: 16px;
    height: 16px;
    border-radius: 2px;
}

.legend-color.selected { background: #28a745; }
.legend-color.unselected { background: #6c757d; opacity: 0.5; }

/* Preview Section */
.preview-section {
    display: grid;
    grid-template-columns: 1fr 280px;
    gap: 1.5rem;
}

.preview-section video {
    width: 100%;
    background: #000;
    border-radius: 8px;
}

.preview-info {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    padding: 1rem;
    background: #f8f9fa;
    border-radius: 8px;
}

.preview-status,
.preview-progress,
.preview-current,
.preview-total {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.status-label,
.progress-label,
.current-label,
.total-label {
    color: #6c757d;
    font-size: 0.875rem;
}

.status-value,
.progress-value,
.current-value,
.total-value {
    font-weight: 600;
}

.status-value.playing {
    color: #28a745;
}

.status-value.transitioning {
    color: #ffc107;
}

.preview-controls {
    display: flex;
    gap: 0.5rem;
}

/* Settings Grid */
.settings-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 1rem;
    padding: 1rem 0;
}

.setting-item {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.setting-item label {
    font-weight: 500;
    font-size: 0.875rem;
}

.setting-item select,
.setting-item input[type="number"] {
    padding: 0.5rem;
    border: 1px solid #ced4da;
    border-radius: 4px;
    font-size: 1rem;
}

/* Selected List */
.selected-list {
    flex: 1;
    overflow-y: auto;
    padding: 0.5rem;
}

.selected-item {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 0.75rem;
    border-bottom: 1px solid #e9ecef;
    transition: background 0.2s;
}

.selected-item:hover {
    background: #f8f9fa;
}

.selected-item.current {
    background: #fff3cd;
}

.item-order {
    width: 28px;
    height: 28px;
    background: #007bff;
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    font-size: 0.875rem;
    flex-shrink: 0;
}

.item-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
}

.item-time {
    font-weight: 500;
}

.item-stats {
    font-size: 0.75rem;
    color: #6c757d;
}

.item-score {
    background: #e9ecef;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-weight: 600;
    font-size: 0.875rem;
}

.empty-state {
    text-align: center;
    padding: 1.5rem 1rem;
    color: #6c757d;
    font-size: 0.875rem;
}

.compilation-info {
    padding: 1rem;
    background: #f8f9fa;
    border-top: 1px solid #e9ecef;
    flex-shrink: 0;
}

.info-row {
    display: flex;
    justify-content: space-between;
    padding: 0.25rem 0;
}

/* Feedback Summary */
.summary-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 1rem;
    text-align: center;
}

.summary-item {
    padding: 1rem;
    background: #f8f9fa;
    border-radius: 8px;
}

.summary-label {
    display: block;
    font-size: 0.75rem;
    color: #6c757d;
    margin-bottom: 0.25rem;
}

.summary-value {
    font-size: 1.5rem;
    font-weight: 600;
}

/* Compile Section */
.compile-section {
    text-align: center;
    padding: 2rem;
}

.compile-warning {
    margin-bottom: 1rem;
    padding: 1rem;
    background: #fff3cd;
    border-radius: 4px;
    color: #856404;
}

.btn-large {
    padding: 1rem 2rem;
    font-size: 1.125rem;
}

/* Progress */
.progress-content {
    padding: 1rem;
}

.progress-bar {
    height: 24px;
    background: #e9ecef;
    border-radius: 12px;
    overflow: hidden;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #007bff, #28a745);
    transition: width 0.3s;
    width: 0;
}

.progress-fill.error {
    background: #dc3545;
}

/* Result Section */
.result-content {
    padding: 1rem;
}

.result-actions {
    display: flex;
    gap: 1rem;
    justify-content: center;
    margin-top: 1rem;
}

/* Responsive */
@media (max-width: 900px) {
    .sidebar {
        width: 280px;
    }

    .sidebar-toggle.sidebar-open {
        transform: translateX(-280px);
    }
}

@media (max-width: 768px) {
    .preview-section {
        grid-template-columns: 1fr;
    }

    .preview-info {
        flex-direction: row;
        flex-wrap: wrap;
        justify-content: space-around;
    }

    .sidebar {
        width: 100%;
    }

    .sidebar-toggle.sidebar-open {
        transform: translateX(-100vw);
    }
}
</style>
{% endblock %}

{% block scripts %}
<script>
let rallies = [];
let allRallies = [];
let selectedRallies = [];
let videoDuration = 0;
let videoFps = 30;

// Compilation config (must match video_compiler.py)
const CONTEXT_BEFORE = 1.0;  // seconds before clip
const CONTEXT_AFTER = 1.5;   // seconds after clip

// Simulation state
let isSimulating = false;
let currentClipIndex = 0;
let simulationClips = [];

const video = document.getElementById('preview-video');

document.addEventListener('DOMContentLoaded', async () => {
    await loadRallies();
    await loadFeedbackSummary();
    restoreSelection();
    setupVideoEvents();
});

async function loadRallies() {
    const response = await fetch('/api/rallies');
    const data = await response.json();
    allRallies = data.rallies;

    // Get fps from first rally
    if (allRallies.length > 0 && allRallies[0].fps) {
        videoFps = allRallies[0].fps;
    }

    // Sort by time
    allRallies.sort((a, b) => a.start_time - b.start_time);

    // Wait for video metadata
    video.onloadedmetadata = () => {
        videoDuration = video.duration;
        renderTimeline();
    };

    if (video.duration) {
        videoDuration = video.duration;
        renderTimeline();
    }
}

function restoreSelection() {
    const saved = sessionStorage.getItem('selectedRallies');
    if (saved) {
        const ids = JSON.parse(saved);
        // Find rallies that are marked as highlight (not rejected)
        selectedRallies = allRallies.filter(r =>
            ids.includes(r.id) || r.is_highlight === true
        );
        // Also include rallies that haven't been rejected (pending)
        if (selectedRallies.length === 0) {
            selectedRallies = allRallies.filter(r => r.is_highlight !== false);
        }
        renderSelectedList();
        renderTimeline();
        updateTotalDuration();
    }
}

function renderTimeline() {
    const timeline = document.getElementById('review-timeline');
    const labels = document.getElementById('time-labels');
    timeline.innerHTML = '';

    const duration = video.duration || videoDuration ||
        Math.max(...allRallies.map(r => r.end_time), 100);

    if (duration > 0) {
        videoDuration = duration;
    }

    const selectedIds = new Set(selectedRallies.map(r => r.id));

    // Render all rallies
    allRallies.forEach((rally, i) => {
        const segment = document.createElement('div');
        segment.className = 'timeline-segment';
        segment.dataset.index = i;

        if (selectedIds.has(rally.id)) {
            segment.classList.add('selected');
        } else {
            segment.classList.add('unselected');
        }

        const left = (rally.start_time / videoDuration) * 100;
        const width = ((rally.end_time - rally.start_time) / videoDuration) * 100;

        segment.style.left = `${left}%`;
        segment.style.width = `${Math.max(width, 0.3)}%`;
        segment.title = `${formatTime(rally.start_time)} - ${formatTime(rally.end_time)}`;

        segment.onclick = () => seekToRally(rally);

        timeline.appendChild(segment);
    });

    // Time labels
    labels.innerHTML = '';
    const numLabels = 10;
    for (let i = 0; i <= numLabels; i++) {
        const label = document.createElement('span');
        label.textContent = formatTime((videoDuration / numLabels) * i);
        labels.appendChild(label);
    }
}

function seekToRally(rally) {
    video.currentTime = rally.start_time;
    video.play();
}

async function autoSelect() {
    const targetDuration = parseInt(document.getElementById('target-duration').value);
    const maxCount = parseInt(document.getElementById('max-clips').value);
    const minScore = parseInt(document.getElementById('min-score-setting').value);

    const response = await fetch('/api/select-highlights', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            target_duration: targetDuration,
            max_count: maxCount,
            min_score: minScore
        })
    });

    if (response.ok) {
        const data = await response.json();
        selectedRallies = data.selected;
        renderSelectedList();
        renderTimeline();
        updateTotalDuration();

        // Save to sessionStorage
        sessionStorage.setItem('selectedRallies',
            JSON.stringify(selectedRallies.map(r => r.id || r.rally?.id)));
    }
}

function renderSelectedList() {
    const container = document.getElementById('selected-list');
    const infoSection = document.getElementById('compilation-info');

    if (selectedRallies.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <p>No highlights selected yet.</p>
                <p>Go to <a href="{{ url_for('candidates') }}">Candidates</a> to select highlights,
                   or click "Auto-select" above.</p>
            </div>
        `;
        infoSection.classList.add('hidden');
        document.getElementById('selection-badge').textContent = '0 selected';
        return;
    }

    container.innerHTML = '';
    infoSection.classList.remove('hidden');

    // Sort by time for display
    const sortedRallies = [...selectedRallies].sort((a, b) =>
        (a.start_time || a.rally?.start_time || 0) - (b.start_time || b.rally?.start_time || 0)
    );

    let totalDuration = 0;

    sortedRallies.forEach((rally, i) => {
        const r = rally.rally || rally;
        const effectiveDuration = getEffectiveClipDuration(rally);
        totalDuration += effectiveDuration;

        const item = document.createElement('div');
        item.className = 'selected-item';
        item.dataset.id = r.id;
        item.innerHTML = `
            <span class="item-order">${i + 1}</span>
            <div class="item-content">
                <span class="item-time">${formatTime(r.start_time)} - ${formatTime(r.end_time)}</span>
                <span class="item-stats">${r.hit_count} hits - ${effectiveDuration.toFixed(1)}s</span>
            </div>
            <span class="item-score">${(rally.score || r.score || 0).toFixed(0)}</span>
            <button class="btn-icon" onclick="removeFromSelection('${r.id}')">x</button>
        `;

        item.onclick = (e) => {
            if (e.target.tagName !== 'BUTTON') {
                seekToRally(r);
            }
        };

        container.appendChild(item);
    });

    document.getElementById('total-duration').textContent = formatTime(totalDuration);
    document.getElementById('clip-count').textContent = selectedRallies.length;
    document.getElementById('selection-badge').textContent = `${selectedRallies.length} selected`;
}

function removeFromSelection(id) {
    selectedRallies = selectedRallies.filter(r => (r.id || r.rally?.id) !== id);
    renderSelectedList();
    renderTimeline();
    updateTotalDuration();
    sessionStorage.setItem('selectedRallies',
        JSON.stringify(selectedRallies.map(r => r.id || r.rally?.id)));
}

function getEffectiveClipDuration(rally) {
    // Calculate duration with context padding (matching compilation)
    const r = rally.rally || rally;
    const start = Math.max(0, r.start_time - CONTEXT_BEFORE);
    const end = Math.min(videoDuration || Infinity, r.end_time + CONTEXT_AFTER);
    return end - start;
}

function updateTotalDuration() {
    let total = 0;
    selectedRallies.forEach(rally => {
        total += getEffectiveClipDuration(rally);
    });
    document.getElementById('preview-total-duration').textContent = formatTime(total);
}

// === SIMULATION FUNCTIONS ===

function setupVideoEvents() {
    video.addEventListener('timeupdate', onVideoTimeUpdate);
    video.addEventListener('ended', onVideoEnded);
}

function startSimulation() {
    if (selectedRallies.length === 0) {
        alert('No highlights selected. Please select some highlights first.');
        return;
    }

    // Sort clips by time order and apply context padding (matching compilation)
    simulationClips = [...selectedRallies]
        .map(r => {
            const rally = r.rally || r;
            return {
                ...rally,
                effective_start: Math.max(0, rally.start_time - CONTEXT_BEFORE),
                effective_end: Math.min(videoDuration || Infinity, rally.end_time + CONTEXT_AFTER)
            };
        })
        .sort((a, b) => a.start_time - b.start_time);

    currentClipIndex = 0;
    isSimulating = true;

    // Update UI
    document.getElementById('simulate-btn').disabled = true;
    document.getElementById('stop-btn').disabled = false;
    document.getElementById('status-text').textContent = 'Playing';
    document.getElementById('status-text').className = 'status-value playing';
    document.getElementById('preview-playhead').style.display = 'block';

    // Start playing first clip
    playCurrentClip();
}

function stopSimulation() {
    isSimulating = false;
    video.pause();

    // Update UI
    document.getElementById('simulate-btn').disabled = false;
    document.getElementById('stop-btn').disabled = true;
    document.getElementById('status-text').textContent = 'Stopped';
    document.getElementById('status-text').className = 'status-value';
    document.getElementById('preview-playhead').style.display = 'none';
    document.getElementById('clip-progress').textContent = '- / -';
    document.getElementById('current-clip-info').textContent = '--';

    // Clear current highlight in list
    document.querySelectorAll('.selected-item').forEach(el => el.classList.remove('current'));
}

function playCurrentClip() {
    if (!isSimulating || currentClipIndex >= simulationClips.length) {
        finishSimulation();
        return;
    }

    const clip = simulationClips[currentClipIndex];

    // Update progress - show effective times (with context padding)
    document.getElementById('clip-progress').textContent =
        `${currentClipIndex + 1} / ${simulationClips.length}`;
    document.getElementById('current-clip-info').textContent =
        `${formatTime(clip.effective_start)} - ${formatTime(clip.effective_end)}`;

    // Highlight current clip in list
    document.querySelectorAll('.selected-item').forEach(el => {
        el.classList.remove('current');
        if (el.dataset.id === clip.id) {
            el.classList.add('current');
            el.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
    });

    // Seek and play from effective start (with context)
    video.currentTime = clip.effective_start;
    video.play();
}

function onVideoTimeUpdate() {
    // Update playhead position
    if (videoDuration > 0) {
        const percent = (video.currentTime / videoDuration) * 100;
        document.getElementById('preview-playhead').style.left = `${percent}%`;
    }

    if (!isSimulating) return;

    const clip = simulationClips[currentClipIndex];
    if (!clip) return;

    // Check if we've reached the end of current clip (using effective_end with context)
    if (video.currentTime >= clip.effective_end - 0.05) {
        // Move to next clip
        currentClipIndex++;

        if (currentClipIndex < simulationClips.length) {
            // Show transition indicator
            document.getElementById('status-text').textContent = 'Transitioning...';
            document.getElementById('status-text').className = 'status-value transitioning';

            // Brief pause to simulate transition, then play next
            setTimeout(() => {
                if (isSimulating) {
                    document.getElementById('status-text').textContent = 'Playing';
                    document.getElementById('status-text').className = 'status-value playing';
                    playCurrentClip();
                }
            }, 300);
        } else {
            finishSimulation();
        }
    }
}

function onVideoEnded() {
    if (isSimulating) {
        // Video ended, move to next clip if any
        currentClipIndex++;
        if (currentClipIndex < simulationClips.length) {
            playCurrentClip();
        } else {
            finishSimulation();
        }
    }
}

function finishSimulation() {
    isSimulating = false;
    video.pause();

    // Update UI
    document.getElementById('simulate-btn').disabled = false;
    document.getElementById('stop-btn').disabled = true;
    document.getElementById('status-text').textContent = 'Preview Complete';
    document.getElementById('status-text').className = 'status-value';
    document.getElementById('clip-progress').textContent = `${simulationClips.length} / ${simulationClips.length}`;

    // Clear current highlight
    document.querySelectorAll('.selected-item').forEach(el => el.classList.remove('current'));
}

// === OTHER FUNCTIONS ===

async function loadFeedbackSummary() {
    const response = await fetch('/api/feedback-summary');
    const summary = await response.json();

    const container = document.getElementById('feedback-summary');

    if (!summary.active) {
        container.innerHTML = '<p>No feedback session active.</p>';
        return;
    }

    container.innerHTML = `
        <div class="summary-grid">
            <div class="summary-item">
                <span class="summary-label">Total Feedback</span>
                <span class="summary-value">${summary.total_feedback}</span>
            </div>
            <div class="summary-item">
                <span class="summary-label">Ratings Given</span>
                <span class="summary-value">${summary.ratings}</span>
            </div>
            <div class="summary-item">
                <span class="summary-label">Confirmed</span>
                <span class="summary-value">${summary.confirmations}</span>
            </div>
            <div class="summary-item">
                <span class="summary-label">Rejected</span>
                <span class="summary-value">${summary.rejections}</span>
            </div>
            <div class="summary-item">
                <span class="summary-label">Boundary Edits</span>
                <span class="summary-value">${summary.boundary_adjustments}</span>
            </div>
            <div class="summary-item">
                <span class="summary-label">Added Rallies</span>
                <span class="summary-value">${summary.missed_rallies}</span>
            </div>
        </div>
    `;
}

async function compileHighlights() {
    if (selectedRallies.length === 0) {
        alert('Please select at least one highlight first.');
        return;
    }

    const compileBtn = document.getElementById('compile-btn');
    const progressSection = document.getElementById('progress-section');
    const progressFill = document.getElementById('compile-progress');
    const statusText = document.getElementById('compile-status');

    compileBtn.disabled = true;
    progressSection.classList.remove('hidden');

    // Simulate progress (actual compilation happens server-side)
    let progress = 0;
    const progressInterval = setInterval(() => {
        progress = Math.min(progress + 5, 90);
        progressFill.style.width = `${progress}%`;

        if (progress < 30) {
            statusText.textContent = 'Extracting clips...';
        } else if (progress < 60) {
            statusText.textContent = 'Processing video...';
        } else {
            statusText.textContent = 'Adding transitions...';
        }
    }, 500);

    try {
        const rallyIds = selectedRallies.map(r => r.id || r.rally?.id);
        console.log('[COMPILE DEBUG] selectedRallies:', selectedRallies);
        console.log('[COMPILE DEBUG] Sending rally_ids:', rallyIds);

        const response = await fetch('/api/compile', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ rally_ids: rallyIds })
        });

        clearInterval(progressInterval);

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error || 'Compilation failed');
        }

        const data = await response.json();

        progressFill.style.width = '100%';
        statusText.textContent = 'Complete!';

        // Show result
        setTimeout(() => {
            progressSection.classList.add('hidden');
            showResult(data);
        }, 500);

    } catch (error) {
        clearInterval(progressInterval);
        progressFill.classList.add('error');
        statusText.textContent = 'Error: ' + error.message;
        compileBtn.disabled = false;
    }
}

function showResult(data) {
    const resultSection = document.getElementById('result-section');
    const resultVideo = document.getElementById('result-video');
    const downloadLink = document.getElementById('download-link');

    // Use the URL path for video and download
    resultVideo.src = data.output_path;
    downloadLink.href = data.output_path;
    downloadLink.download = data.filename || 'highlights.mp4';

    resultSection.classList.remove('hidden');
    resultSection.scrollIntoView({ behavior: 'smooth' });
}

function startOver() {
    sessionStorage.clear();
    window.location.href = '{{ url_for("index") }}';
}

function formatTime(seconds) {
    if (seconds === undefined || seconds === null) return '00:00:00.00';
    const hrs = Math.floor(seconds / 3600);
    const mins = Math.floor((seconds % 3600) / 60);
    const secs = Math.floor(seconds % 60);
    const centis = Math.floor((seconds % 1) * 100);
    return `${hrs.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}.${centis.toString().padStart(2, '0')}`;
}

function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    const toggle = document.querySelector('.sidebar-toggle');
    sidebar.classList.toggle('hidden');
    toggle.classList.toggle('sidebar-open');
}
</script>
{% endblock %}
