{% extends "base.html" %}

{% block title %}TT Highlights - Timeline{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Video Timeline</h1>
    <p>Review detected segments and adjust boundaries</p>
</div>

<div class="card">
    <div class="card-header">
        <h2>Video Analysis</h2>
        <button id="analyze-btn" class="btn btn-primary" onclick="startAnalysis()">
            Start Analysis
        </button>
    </div>

    <div id="analysis-status" class="status-panel hidden">
        <div class="spinner"></div>
        <span id="status-text">Analyzing video...</span>
    </div>

    <div id="video-info" class="hidden">
        <div class="info-grid">
            <div class="info-item">
                <span class="info-label">Duration</span>
                <span class="info-value" id="duration-value">--</span>
            </div>
            <div class="info-item">
                <span class="info-label">Resolution</span>
                <span class="info-value" id="resolution-value">--</span>
            </div>
            <div class="info-item">
                <span class="info-label">Ball Hits</span>
                <span class="info-value" id="hits-value">--</span>
            </div>
            <div class="info-item">
                <span class="info-label">Rallies Found</span>
                <span class="info-value" id="rallies-value">--</span>
            </div>
        </div>
    </div>
</div>

<div id="timeline-container" class="card hidden">
    <div class="card-header">
        <h2>Timeline</h2>
        <div class="timeline-controls">
            <button class="btn btn-icon" onclick="zoomIn()" title="Zoom In">üîç+</button>
            <button class="btn btn-icon" onclick="zoomOut()" title="Zoom Out">üîç-</button>
        </div>
    </div>

    <div class="timeline-wrapper">
        <div id="waveform" class="waveform"></div>
        <div id="timeline" class="timeline">
            <div id="time-markers" class="time-markers"></div>
            <div id="segments" class="segments"></div>
        </div>
    </div>

    <div class="video-preview">
        <video id="video-player" controls>
            <source src="{{ url_for('serve_video') }}" type="video/mp4">
        </video>
    </div>
</div>

<div id="rallies-list" class="card hidden">
    <div class="card-header">
        <h2>Detected Rallies</h2>
        <button class="btn btn-secondary" onclick="addMissedRally()">
            + Add Missed Rally
        </button>
    </div>

    <div class="rallies-grid" id="rallies-grid">
        <!-- Populated by JavaScript -->
    </div>

    <div class="card-footer">
        <a href="{{ url_for('candidates') }}" class="btn btn-primary">
            Continue to Candidate Review ‚Üí
        </a>
    </div>
</div>

<!-- Rally Edit Modal -->
<div id="rally-modal" class="modal hidden">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Edit Rally</h3>
            <button class="btn-icon" onclick="closeModal()">‚úï</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>Start Time (seconds)</label>
                <input type="number" id="edit-start" step="0.1" min="0">
            </div>
            <div class="form-group">
                <label>End Time (seconds)</label>
                <input type="number" id="edit-end" step="0.1" min="0">
            </div>
            <div class="form-group">
                <label>Is this a valid rally?</label>
                <div class="button-group">
                    <button class="btn btn-success" onclick="confirmRally(true)">‚úì Yes, good rally</button>
                    <button class="btn btn-danger" onclick="confirmRally(false)">‚úï No, remove it</button>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            <button class="btn btn-primary" onclick="saveRallyEdit()">Save Changes</button>
        </div>
    </div>
</div>

<!-- Add Rally Modal -->
<div id="add-rally-modal" class="modal hidden">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Add Missed Rally</h3>
            <button class="btn-icon" onclick="closeAddModal()">‚úï</button>
        </div>
        <div class="modal-body">
            <p>Mark the start and end times of a rally the system missed.</p>
            <div class="form-group">
                <label>Start Time (seconds)</label>
                <input type="number" id="new-start" step="0.1" min="0" placeholder="e.g., 45.5">
            </div>
            <div class="form-group">
                <label>End Time (seconds)</label>
                <input type="number" id="new-end" step="0.1" min="0" placeholder="e.g., 58.2">
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeAddModal()">Cancel</button>
            <button class="btn btn-primary" onclick="submitNewRally()">Add Rally</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let rallies = [];
let currentEditRally = null;
let videoDuration = 0;
let zoomLevel = 1;

async function startAnalysis() {
    const btn = document.getElementById('analyze-btn');
    const status = document.getElementById('analysis-status');
    const statusText = document.getElementById('status-text');

    btn.disabled = true;
    status.classList.remove('hidden');

    try {
        statusText.textContent = 'Extracting audio and analyzing...';

        const response = await fetch('/api/analyze', { method: 'POST' });
        const data = await response.json();

        if (!response.ok) throw new Error(data.error);

        // Show video info
        const info = document.getElementById('video-info');
        info.classList.remove('hidden');

        document.getElementById('duration-value').textContent =
            formatTime(data.metadata.duration);
        document.getElementById('resolution-value').textContent =
            `${data.metadata.width}x${data.metadata.height}`;
        document.getElementById('hits-value').textContent = data.num_ball_hits;
        document.getElementById('rallies-value').textContent = data.num_rallies;

        videoDuration = data.metadata.duration;

        // Load volume data and rallies
        statusText.textContent = 'Loading visualization...';
        await loadVolumeData();
        await loadRallies();

        status.classList.add('hidden');
        document.getElementById('timeline-container').classList.remove('hidden');
        document.getElementById('rallies-list').classList.remove('hidden');

    } catch (error) {
        statusText.textContent = 'Error: ' + error.message;
        btn.disabled = false;
    }
}

async function loadVolumeData() {
    const response = await fetch('/api/volume-data');
    const data = await response.json();

    if (data.times && data.volumes) {
        drawWaveform(data.times, data.volumes);
    }
}

function drawWaveform(times, volumes) {
    const container = document.getElementById('waveform');
    const width = container.clientWidth;
    const height = 60;

    // Create SVG
    const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
    svg.setAttribute('width', width);
    svg.setAttribute('height', height);

    // Create path
    const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');

    let d = `M 0 ${height}`;

    for (let i = 0; i < volumes.length; i++) {
        const x = (i / volumes.length) * width;
        const y = height - (volumes[i] * height * 0.9);
        d += ` L ${x} ${y}`;
    }

    d += ` L ${width} ${height} Z`;

    path.setAttribute('d', d);
    path.setAttribute('fill', 'rgba(74, 144, 226, 0.5)');
    path.setAttribute('stroke', 'rgba(74, 144, 226, 0.8)');
    path.setAttribute('stroke-width', '1');

    svg.appendChild(path);
    container.innerHTML = '';
    container.appendChild(svg);

    // Add time markers
    drawTimeMarkers();
}

function drawTimeMarkers() {
    const container = document.getElementById('time-markers');
    container.innerHTML = '';

    const numMarkers = 10;
    const interval = videoDuration / numMarkers;

    for (let i = 0; i <= numMarkers; i++) {
        const time = i * interval;
        const marker = document.createElement('div');
        marker.className = 'time-marker';
        marker.style.left = `${(i / numMarkers) * 100}%`;
        marker.textContent = formatTime(time);
        container.appendChild(marker);
    }
}

async function loadRallies() {
    const response = await fetch('/api/rallies');
    const data = await response.json();

    rallies = data.rallies;
    renderRallies();
    renderSegments();
}

function renderSegments() {
    const container = document.getElementById('segments');
    container.innerHTML = '';

    rallies.forEach((rally, i) => {
        const segment = document.createElement('div');
        segment.className = 'segment';
        if (rally.is_highlight === true) segment.classList.add('confirmed');
        if (rally.is_highlight === false) segment.classList.add('rejected');

        const left = (rally.start_time / videoDuration) * 100;
        const width = ((rally.end_time - rally.start_time) / videoDuration) * 100;

        segment.style.left = `${left}%`;
        segment.style.width = `${width}%`;
        segment.title = `Rally ${i + 1}: ${formatTime(rally.start_time)} - ${formatTime(rally.end_time)}`;

        segment.onclick = () => seekTo(rally.start_time);

        container.appendChild(segment);
    });
}

function renderRallies() {
    const grid = document.getElementById('rallies-grid');
    grid.innerHTML = '';

    rallies.forEach((rally, i) => {
        const card = document.createElement('div');
        card.className = 'rally-card';
        if (rally.is_highlight === true) card.classList.add('confirmed');
        if (rally.is_highlight === false) card.classList.add('rejected');

        card.innerHTML = `
            <div class="rally-header">
                <span class="rally-number">#${i + 1}</span>
                <span class="rally-score">Score: ${rally.score.toFixed(0)}</span>
            </div>
            <div class="rally-info">
                <div class="rally-time">
                    ${formatTime(rally.start_time)} - ${formatTime(rally.end_time)}
                </div>
                <div class="rally-stats">
                    <span>${rally.hit_count} hits</span>
                    <span>${rally.duration.toFixed(1)}s</span>
                </div>
            </div>
            <div class="rally-actions">
                <button class="btn btn-small" onclick="playRally('${rally.id}')">‚ñ∂ Play</button>
                <button class="btn btn-small" onclick="editRally('${rally.id}')">Edit</button>
                <div class="rating-stars" data-rally="${rally.id}">
                    ${renderStars(rally.user_rating)}
                </div>
            </div>
        `;

        grid.appendChild(card);
    });
}

function renderStars(rating) {
    let html = '';
    for (let i = 1; i <= 5; i++) {
        const filled = rating && i <= rating;
        html += `<span class="star ${filled ? 'filled' : ''}" onclick="rateRally(event, ${i})">‚òÖ</span>`;
    }
    return html;
}

async function rateRally(event, rating) {
    const rallyId = event.target.closest('.rating-stars').dataset.rally;

    const response = await fetch(`/api/rally/${rallyId}/rate`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ rating })
    });

    if (response.ok) {
        const data = await response.json();
        // Update local data
        const rally = rallies.find(r => r.id === rallyId);
        if (rally) rally.user_rating = rating;
        renderRallies();
    }
}

function playRally(rallyId) {
    const rally = rallies.find(r => r.id === rallyId);
    if (rally) {
        seekTo(rally.start_time);
        document.getElementById('video-player').play();
    }
}

function editRally(rallyId) {
    const rally = rallies.find(r => r.id === rallyId);
    if (!rally) return;

    currentEditRally = rally;
    document.getElementById('edit-start').value = rally.start_time.toFixed(1);
    document.getElementById('edit-end').value = rally.end_time.toFixed(1);
    document.getElementById('rally-modal').classList.remove('hidden');
}

function closeModal() {
    document.getElementById('rally-modal').classList.add('hidden');
    currentEditRally = null;
}

async function confirmRally(isHighlight) {
    if (!currentEditRally) return;

    const response = await fetch(`/api/rally/${currentEditRally.id}/confirm`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ is_highlight: isHighlight })
    });

    if (response.ok) {
        currentEditRally.is_highlight = isHighlight;
        currentEditRally.is_confirmed = true;
        renderRallies();
        renderSegments();
        closeModal();
    }
}

async function saveRallyEdit() {
    if (!currentEditRally) return;

    const newStart = parseFloat(document.getElementById('edit-start').value);
    const newEnd = parseFloat(document.getElementById('edit-end').value);

    const response = await fetch(`/api/rally/${currentEditRally.id}/adjust`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ start_time: newStart, end_time: newEnd })
    });

    if (response.ok) {
        currentEditRally.start_time = newStart;
        currentEditRally.end_time = newEnd;
        renderRallies();
        renderSegments();
        closeModal();
    }
}

function addMissedRally() {
    document.getElementById('add-rally-modal').classList.remove('hidden');
}

function closeAddModal() {
    document.getElementById('add-rally-modal').classList.add('hidden');
}

async function submitNewRally() {
    const startTime = parseFloat(document.getElementById('new-start').value);
    const endTime = parseFloat(document.getElementById('new-end').value);

    if (isNaN(startTime) || isNaN(endTime) || startTime >= endTime) {
        alert('Please enter valid start and end times');
        return;
    }

    const response = await fetch('/api/add-rally', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ start_time: startTime, end_time: endTime })
    });

    if (response.ok) {
        await loadRallies();
        closeAddModal();
        document.getElementById('new-start').value = '';
        document.getElementById('new-end').value = '';
    }
}

function seekTo(time) {
    const video = document.getElementById('video-player');
    video.currentTime = time;
}

function zoomIn() {
    zoomLevel = Math.min(zoomLevel * 1.5, 5);
    applyZoom();
}

function zoomOut() {
    zoomLevel = Math.max(zoomLevel / 1.5, 1);
    applyZoom();
}

function applyZoom() {
    const timeline = document.querySelector('.timeline-wrapper');
    timeline.style.width = `${100 * zoomLevel}%`;
}

function formatTime(seconds) {
    const mins = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60);
    return `${mins}:${secs.toString().padStart(2, '0')}`;
}
</script>
{% endblock %}
